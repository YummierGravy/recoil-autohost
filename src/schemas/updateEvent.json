{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://beyondallreason.dev/schema/tachyon/autohost/update/event",
  "title": "UpdateEvent",
  "type": "object",
  "properties": {
    "battleId": {
      "type": "string",
      "format": "uuid"
    },
    "time": {
      "type": "integer",
      "description": "Unix timestamp in microseconds"
    },
    "update": {
      "oneOf": [
        { "$ref": "#/$defs/start" },
        { "$ref": "#/$defs/finished" },
        { "$ref": "#/$defs/engineMessage" },
        { "$ref": "#/$defs/engineWarning" },
        { "$ref": "#/$defs/engineQuit" },
        { "$ref": "#/$defs/engineCrash" },
        { "$ref": "#/$defs/playerJoined" },
        { "$ref": "#/$defs/playerLeft" },
        { "$ref": "#/$defs/playerChat" },
        { "$ref": "#/$defs/playerDefeated" },
        { "$ref": "#/$defs/luamsg" }
      ]
    }
  },
  "required": ["battleId", "time", "update"],
  "additionalProperties": false,
  "$defs": {
    "start": {
      "type": "object",
      "title": "StartUpdate",
      "description": "The battle started.",
      "properties": {
        "type": {
          "const": "start"
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "finished": {
      "type": "object",
      "title": "FinishedUpdate",
      "description": "The battle finished, generated once per every single player reporting who won.",
      "properties": {
        "type": {
          "const": "finished"
        },
        "userId": {
          "type": "string"
        },
        "winningAllyTeams": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "integer",
            "description": "Ally team IDs"
          }
        }
      },
      "required": ["type", "userId", "winningAllyTeams"],
      "additionalProperties": false
    },
    "engineMessage": {
      "type": "object",
      "title": "EngineMessageUpdate",
      "description": "A message from the engine, e.g. some ip is trying to connect.",
      "properties": {
        "type": {
          "const": "engine_message"
        },
        "message": {
          "type": "string"
        }
      },
      "required": ["type", "message"],
      "additionalProperties": false
    },
    "engineWarning": {
      "type": "object",
      "title": "EngineWarningUpdate",
      "properties": {
        "type": {
          "const": "engine_warning"
        },
        "message": {
          "type": "string"
        }
      },
      "required": ["type", "message"],
      "additionalProperties": false
    },
    "engineQuit": {
      "type": "object",
      "title": "EngineQuitUpdate",
      "description": "The engine process for battle has quit cleanly, no more updates will be sent for this battle.",
      "properties": {
        "type": {
          "const": "engine_quit"
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "engineCrash": {
      "type": "object",
      "title": "EngineCrashUpdate",
      "description": "The engine process for battle has crashed, no more updates will be sent for this battle.",
      "properties": {
        "type": {
          "const": "engine_crash"
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "playerJoined": {
      "type": "object",
      "title": "PlayerJoinedUpdate",
      "properties": {
        "type": {
          "const": "player_joined"
        },
        "userId": {
          "type": "string"
        },
        "playerNumber": {
          "type": "integer",
          "description": "Player number in the game, can be useful for custom commands"
        }
      },
      "required": ["type", "userId", "playerNumber"],
      "additionalProperties": false
    },
    "playerLeft": {
      "type": "object",
      "title": "PlayerLeftUpdate",
      "properties": {
        "type": {
          "const": "player_left"
        },
        "userId": {
          "type": "string"
        },
        "reason": {
          "enum": ["lost_connection", "left", "kicked"]
        }
      },
      "required": ["type", "userId", "reason"],
      "additionalProperties": false
    },
    "playerChat": {
      "type": "object",
      "title": "PlayerChatUpdate",
      "properties": {
        "type": {
          "const": "player_chat"
        },
        "userId": {
          "type": "string"
        },
        "message": {
          "type": "string"
        },
        "destination": {
          "enum": ["allies", "all", "spectators", "player"]
        },
        "toUserId": {
          "type": "string",
          "$comment": "Only if destination is 'player'"
        }
      },
      "required": ["type", "userId", "message", "destination"],
      "additionalProperties": false
    },
    "playerDefeated": {
      "type": "object",
      "title": "PlayerDefeatedUpdate",
      "properties": {
        "type": {
          "const": "player_defeated"
        },
        "userId": {
          "type": "string"
        }
      },
      "required": ["type", "userId"],
      "additionalProperties": false
    },
    "luamsg": {
      "type": "object",
      "title": "LuaMsgUpdate",
      "properties": {
        "type": {
          "const": "luamsg"
        },
        "userId": {
          "type": "string"
        },
        "script": {
          "enum": ["ui", "gaia", "rules"]
        },
        "uiMode": {
          "enum": ["all", "allies", "spectators"],
          "$comment": "Only if script is 'ui'"
        },
        "data": {
          "type": "string",
          "contentEncoding": "base64",
          "contentMediaType": "application/octet-stream"
        }
      },
      "required": ["type", "userId", "script", "data"],
      "additionalProperties": false
    }
  }
}
